name: Deploy Solana Program

on:
  push:
    branches:
      - main
    paths:
      - 'programs/**'
      - 'Anchor.toml'
  workflow_dispatch:
    inputs:
      network:
        description: 'Network to deploy to'
        required: true
        default: 'devnet'
        type: choice
        options:
          - devnet
          - mainnet-beta

env:
  SOLANA_VERSION: '1.18.17'
  ANCHOR_VERSION: '0.30.1'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust 1.75.0
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: '1.75.0'

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            ~/.local/share/solana/
          key: ${{ runner.os }}-solana-${{ env.SOLANA_VERSION }}-anchor-${{ env.ANCHOR_VERSION }}-v2

      - name: Install Solana CLI
        run: |
          SOLANA_DIR="$HOME/.local/share/solana/install/active_release"
          if [ ! -f "$SOLANA_DIR/bin/solana" ]; then
            echo "Downloading Solana CLI v$SOLANA_VERSION from GitHub releases..."
            curl -L "https://github.com/solana-labs/solana/releases/download/v$SOLANA_VERSION/solana-release-x86_64-unknown-linux-gnu.tar.bz2" -o solana.tar.bz2
            tar -xjf solana.tar.bz2
            mkdir -p "$SOLANA_DIR"
            cp -r solana-release/* "$SOLANA_DIR/"
            chmod +x "$SOLANA_DIR/bin/"*
            rm -rf solana.tar.bz2 solana-release
          else
            echo "Solana CLI already cached"
          fi
          echo "$SOLANA_DIR/bin" >> $GITHUB_PATH

      - name: Install Anchor CLI
        run: |
          export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
          solana --version
          
          if [ ! -f "$HOME/.cargo/bin/anchor" ]; then
            echo "Installing Anchor CLI v$ANCHOR_VERSION directly..."
            cargo install --git https://github.com/coral-xyz/anchor --tag v$ANCHOR_VERSION anchor-cli --locked --force
          else
            echo "Anchor CLI already cached"
          fi
          
          anchor --version
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Setup wallet and configure network
        run: |
          mkdir -p ~/.config/solana
          echo '${{ secrets.SOLANA_PRIVATE_KEY }}' > ~/.config/solana/id.json
          chmod 600 ~/.config/solana/id.json
          
          NETWORK=${{ github.event.inputs.network || 'devnet' }}
          if [ "$NETWORK" = "mainnet-beta" ]; then
            solana config set --url https://api.mainnet-beta.solana.com
          else
            solana config set --url https://api.devnet.solana.com
          fi
          solana config set --keypair ~/.config/solana/id.json
          
          echo "Wallet address:"
          solana address
          echo "Balance:"
          BALANCE=$(solana balance | awk '{print $1}')
          echo "$BALANCE SOL"
          if (( $(echo "$BALANCE < 3" | bc -l) )); then
            echo "WARNING: Low balance. May need at least 3 SOL to deploy."
          fi

      - name: Setup Program Keypair
        run: |
          mkdir -p target/deploy
          echo '${{ secrets.PROGRAM_KEYPAIR }}' > target/deploy/pm15-keypair.json
          chmod 600 target/deploy/pm15-keypair.json
          PROGRAM_ID=$(solana address -k target/deploy/pm15-keypair.json)
          echo "Program ID: $PROGRAM_ID"
          echo "PROGRAM_ID=$PROGRAM_ID" >> $GITHUB_ENV

      - name: Pin borsh for Rust 1.75 compatibility
        run: |
          echo "Pinning borsh to version compatible with Solana 1.18 toolchain (Rust 1.75)..."
          cargo update -p borsh --precise 1.5.1
          echo "borsh pinned to 1.5.1"

      - name: Build Anchor program
        run: |
          echo "=== Build Environment ==="
          echo "Rust: $(rustc --version)"
          echo "Solana: $(solana --version)"
          echo "Anchor: $(anchor --version)"
          echo ""
          
          echo "=== Cargo.toml dependencies ==="
          cat programs/pm15/Cargo.toml | grep -A5 "\[dependencies\]"
          echo ""
          
          echo "=== Building ==="
          anchor build 2>&1 | tee build_output.txt
          
          echo ""
          echo "=== Build artifacts ==="
          ls -la target/deploy/ || echo "target/deploy not found"
          
          if [ ! -f target/deploy/pm15.so ]; then
            echo ""
            echo "ERROR: Build failed - pm15.so not found"
            cat build_output.txt
            exit 1
          fi
          
          echo ""
          echo "=== Program size ==="
          ls -lh target/deploy/pm15.so

      - name: Deploy to Solana
        run: |
          NETWORK=${{ github.event.inputs.network || 'devnet' }}
          echo "Deploying to $NETWORK..."
          echo "Program ID: $PROGRAM_ID"
          
          anchor deploy --provider.cluster $NETWORK 2>&1 | tee deploy_output.txt
          DEPLOY_EXIT_CODE=${PIPESTATUS[0]}
          
          if [ $DEPLOY_EXIT_CODE -ne 0 ]; then
            echo "ERROR: Deploy failed"
            cat deploy_output.txt
            exit 1
          fi
          
          echo ""
          echo "Verifying deployment..."
          sleep 10
          
          if [ "$NETWORK" = "mainnet-beta" ]; then
            RPC_URL="https://api.mainnet-beta.solana.com"
          else
            RPC_URL="https://api.devnet.solana.com"
          fi
          
          if solana program show $PROGRAM_ID --url $RPC_URL; then
            echo ""
            echo "SUCCESS: Program verified on-chain!"
          else
            echo "WARNING: Could not verify program on-chain"
          fi

      - name: Output Result
        run: |
          echo "=============================================="
          echo "DEPLOYMENT COMPLETE"
          echo "=============================================="
          echo "Program ID: $PROGRAM_ID"
          echo "Network: ${{ github.event.inputs.network || 'devnet' }}"
          echo "Explorer: https://explorer.solana.com/address/$PROGRAM_ID?cluster=${{ github.event.inputs.network || 'devnet' }}"
          echo "=============================================="
